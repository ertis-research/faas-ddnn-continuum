# DOCKER_PREFIX=192.168.43.7:30501 faas build -f inference.yml && DOCKER_PREFIX=192.168.43.7:30501 faas push -f inference.yml && DOCKER_PREFIX=10.10.32.10:30501 faas deploy -f inference.yml
version: 1.0
provider:
  name: openfaas
  gateway: http://192.168.43.7:31112
functions:
  funnel-edge-output:
    lang: python3-http
    handler: ./kafka-funnel
    image: ${DOCKER_PREFIX:-registry.hub.docker.com}/kafka-funnel:latest
    label:
      com.openfaas.scale.max: 10
    environment:
      FUNNEL_TOPIC: openfaas.inference.edge-output
      FUNNEL_PRODUCER: >
        {
          "bootstrap_servers":
            [
              "kafka-0.kafka-headless.kafka:9092",
              "kafka-1.kafka-headless.kafka:9092"
            ]
        }

  funnel-fog-input:
    lang: python3-http
    handler: ./kafka-funnel
    image: ${DOCKER_PREFIX:-registry.hub.docker.com}/kafka-funnel:latest
    label:
      com.openfaas.scale.max: 10
    environment:
      FUNNEL_TOPIC: openfaas.inference.fog-input
      FUNNEL_PRODUCER: >
        {
          "bootstrap_servers":
            [
              "kafka-0.kafka-headless.kafka:9092",
              "kafka-1.kafka-headless.kafka:9092"
            ]
        }

  funnel-fog-output:
    lang: python3-http
    handler: ./kafka-funnel
    image: ${DOCKER_PREFIX:-registry.hub.docker.com}/kafka-funnel:latest
    label:
      com.openfaas.scale.max: 10
    environment:
      FUNNEL_TOPIC: openfaas.inference.fog-output
      FUNNEL_PRODUCER: >
        {
          "bootstrap_servers": [
              "kafka-0.kafka-headless.kafka:9092",
              "kafka-1.kafka-headless.kafka:9092"
            ]
        }

  funnel-cloud-input:
    lang: python3-http
    handler: ./kafka-funnel
    image: ${DOCKER_PREFIX:-registry.hub.docker.com}/kafka-funnel:latest
    label:
      com.openfaas.scale.max: 10
    environment:
      FUNNEL_TOPIC: openfaas.inference.cloud-input
      FUNNEL_PRODUCER: >
        {
          "bootstrap_servers": [
              "kafka-0.kafka-headless.kafka:9092",
              "kafka-1.kafka-headless.kafka:9092"
            ]
        }

  funnel-cloud-output:
    lang: python3-http
    handler: ./kafka-funnel
    image: ${DOCKER_PREFIX:-registry.hub.docker.com}/kafka-funnel:latest
    label:
      com.openfaas.scale.max: 10
    environment:
      FUNNEL_TOPIC: openfaas.inference.cloud-output
      FUNNEL_PRODUCER: >
        {
          "bootstrap_servers": [
              "kafka-0.kafka-headless.kafka:9092",
              "kafka-1.kafka-headless.kafka:9092"
            ]
        }

  edge:
    lang: python3-http-tensor
    handler: ./inference
    image: ${DOCKER_PREFIX:-registry.hub.docker.com}/inference:latest
    label:
      com.openfaas.scale.max: 20
      com.openfaas.scale.factor: 50%
    environment:
      MODEL: "function/edge.h5"
      EXIT_URL: http://gateway.openfaas:8080/function/funnel-edge-output
      NEXT_URL: http://gateway.openfaas:8080/function/funnel-fog-input
      NEXT_CONFIDENCE: .65

    limits:
      cpu: 1000m
      memory: 1024Mi
    requests:
      cpu: 1000m
      memory: 1024Mi

  fog:
    lang: python3-http-tensor
    handler: ./inference
    image: ${DOCKER_PREFIX:-registry.hub.docker.com}/inference:latest
    label:
      com.openfaas.scale.max: 20
      com.openfaas.scale.factor: 50%
    environment:
      MODEL: "function/fog.h5"
      EXIT_URL: http://gateway.openfaas:8080/function/funnel-fog-output
      NEXT_URL: http://gateway.openfaas:8080/function/funnel-cloud-input
      NEXT_CONFIDENCE: .50

    limits:
      cpu: 1000m
      memory: 1024Mi
    requests:
      cpu: 1000m
      memory: 1024Mi

  cloud:
    lang: python3-http-tensor
    handler: ./inference
    image: ${DOCKER_PREFIX:-registry.hub.docker.com}/inference:latest
    label:
      com.openfaas.scale.max: 20
      com.openfaas.scale.factor: 50%
    environment:
      MODEL: "function/cloud.h5"
      EXIT_URL: http://gateway.openfaas:8080/function/funnel-cloud-output

    limits:
      cpu: 1000m
      memory: 1024Mi
    requests:
      cpu: 1000m
      memory: 1024Mi

  test:
    lang: python3-http-tensor
    handler: ./inference
    image: ${DOCKER_PREFIX:-registry.hub.docker.com}/inference:latest
    label:
      com.openfaas.scale.max: 10
    environment:
      MODEL: "function/test.h5"
      EXIT_URL: http://gateway.openfaas:8080/function/kafka-funnel
