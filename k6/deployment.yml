apiVersion: apps/v1
kind: Deployment
metadata:
  name: k6-load-deployment
  labels:
    app: k6-load
spec:
  selector:
    matchLabels:
      app: k6-load
  replicas: 1
  template:
    metadata:
      labels:
        app: k6-load
    spec:
      nodeName: node1
      containers:
        - name: k6
          image: grafana/k6:0.41.0
          command: ["k6", "run", "--out", "csv", "/d/script.js"]
          env:
            - name: "SCRIPT_URL"
              value: "http://gateway-external.openfaas.svc.cluster.local:8080/function/echo-py" # TODO URL donde conectarse
            - name: SCRIPT_DATASET
              value: "/d/payloads.json"
            - name: "K6_VUS"
              value: "1"
            - name: SCRIPT_SLEEP_FOR
              value: "1"
            - name: "K6_CSV_FILENAME"
              value: /d/out/results.csv
          volumeMounts:
            - mountPath: /d/out
              name: k6-csv
            - mountPath: /d/script.js
              name: k6-script
            - mountPath: /d/payloads.json
              name: k6-payloads
      volumes:
        - name: k6-csv
          hostPath:
            path: /lambda/k6/out
            type: DirectoryOrCreate
        - name: k6-script
          hostPath:
            path: /lambda/k6/script.js
            type: File
        - name: k6-payloads
          hostPath:
            path: /lambda/k6/payloads.json
            type: File
